name: Archive Predictions

on:
  schedule:
    - cron: "0 2 * * 1" # Sunday, 9PM EST
  workflow_dispatch:

jobs:
  archive-predictions:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: nfl
          environment-file: environment.yml
          python-version: 3.13

      - name: Verify environment
        shell: bash -el {0}
        run: |
          python -c "import pymc; print(f'PyMC version: {pymc.__version__}')"
          python -c "import nflreadpy; print('nflreadpy installed successfully')"

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: fit_model.yml
          name: model-*
          name_is_regexp: true
          path: temp-models/
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Move model
        run: |
          MODEL_FILE=$(find temp-models/ -name "model_*_*.nc" -type f | sort -V | tail -n 1)
          if [ -n "$MODEL_FILE" ]; then
            mkdir -p models/
            cp "$MODEL_FILE" models/
          else
            echo "Error: No model file found"
            exit 1
          fi
          rm -rf temp-models/

      - name: Run update script with save flag
        shell: bash -el {0}
        run: |
          python -m scripts.update --save-predictions

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push prediction file
        run: |
          git add predictions/*
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Automated prediction update - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi

      - name: Delete artifacts
        if: success()
        run: |
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate -q '.artifacts[] | select(.name | startswith("model")) | .id')
          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found to delete"
          else
            for id in $ARTIFACTS; do
              gh api --method DELETE repos/${{ github.repository }}/actions/artifacts/$id
            done
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete deployments
        run: |
          DEPLOYMENTS=$(gh api repos/${{ github.repository }}/deployments --paginate -q '.[].id')
          if [ -z "$DEPLOYMENTS" ]; then
            echo "No deployments found to delete"
          else
            for id in $(echo "$DEPLOYMENTS" | tail -n +2); do
              gh api --method DELETE repos/${{ github.repository }}/deployments/$id
            done
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
