name: Fit Model

on:
  schedule:
    - cron: "0 10 * * 2" # Tuesday, 5AM EST
  workflow_dispatch:

jobs:
  fit-model:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: nfl
          environment-file: environment.yml
          python-version: 3.13

      - name: Verify environment
        shell: bash -el {0}
        run: |
          python -c "import pymc; print(f'PyMC version: {pymc.__version__}')"
          python -c "import nflreadpy; print('nflreadpy installed successfully')"

      - name: Run model
        shell: bash -el {0}
        env:
          PYTENSOR_FLAGS: "blas__ldflags=-llapack -lblas -lcblas"
        run: |
          python -m scripts.predict --chains 4 --cores 2

      - name: Verify outputs
        id: verify
        run: |
          MODEL_FILE=$(find models/ -name "model_*_*.nc" -type f | sort -V | tail -n 1)
          if [ -z "$MODEL_FILE" ]; then
            echo "Error: No model file found"
            exit 1
          fi
          echo "Model file: $MODEL_FILE"
          echo "model_file=$MODEL_FILE" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: model-${{ github.run_number }}
          path: ${{ steps.verify.outputs.model_file }}
          retention-days: 6
