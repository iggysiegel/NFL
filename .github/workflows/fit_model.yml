name: Fit Model Weekly

on:
  schedule:
    - cron: "0 10 * * 2" # Tuesday, 5AM EST
  workflow_dispatch:

jobs:
  fit-model:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.13"
          miniconda-version: "latest"
          activate-environment: nfl

      - name: Install dependencies
        shell: bash -el {0}
        run: |
          conda install -c conda-forge "pymc>=5" pyarrow tqdm
          pip install nflreadpy
          python -c "import pymc; print(f'PyMC version: {pymc.__version__}')"
          python -c "import nflreadpy; print('nflreadpy installed successfully')"

      - name: Run model
        shell: bash -el {0}
        env:
          PYTENSOR_FLAGS: "blas__ldflags=-llapack -lblas -lcblas"
          PYTHONUNBUFFERED: "1"
        run: |
          echo "Starting model..."
          python -m scripts.predict --chains 4 --cores 2 --draws 10 --tune 10
          echo "Model execution completed"

      - name: Verify outputs
        id: verify
        run: |
          MODEL_FILE=$(find models/ -name "model_*_*.nc" -type f | sort -V | tail -n 1)
          if [ -z "$MODEL_FILE" ]; then
            echo "Error: No model file found"
            exit 1
          fi
          echo "model_file=$MODEL_FILE" >> $GITHUB_OUTPUT
          echo "Model file: $MODEL_FILE"

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: nfl-model-${{ github.run_number }}
          path: ${{ steps.verify.outputs.model_file }}
          retention-days: 14

      - name: Summary
        if: always()
        run: |
          echo "## Model Fitting Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
