name: Update Website Weekly

on:
  workflow_run:
    workflows: ["Fit Model Weekly"]
    types:
      - completed
  workflow_dispatch:

jobs:
  update-website:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          pip install nflreadpy pandas pyarrow
          python -c "import nflreadpy; print('nflreadpy installed successfully')"

      - name: Download model artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: fit_model.yml
          name_is_regexp: true
          name: nfl-model-.*
          path: temp-models/
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Download predictions artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: fit_model.yml
          name_is_regexp: true
          name: nfl-predictions-.*
          path: temp-predictions/
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Move files to correct locations
        run: |
          # Find and move model file
          MODEL_FILE=$(find temp-models/ -name "model_*_*.nc" -type f)
          if [ -n "$MODEL_FILE" ]; then
            mkdir -p models/
            cp "$MODEL_FILE" models/
            echo "Moved model: $(basename $MODEL_FILE)"
          else
            echo "Error: No model file found"
            exit 1
          fi

          # Find and move prediction file
          PRED_FILE=$(find temp-predictions/ -name "state_space_*_*.csv" -type f)
          if [ -n "$PRED_FILE" ]; then
            mkdir -p predictions/
            cp "$PRED_FILE" predictions/
            echo "Moved predictions: $(basename $PRED_FILE)"
          else
            echo "Error: No predictions file found"
            exit 1
          fi

          # Clean up temp directories
          rm -rf temp-models/ temp-predictions/

          echo ""
          echo "Final structure:"
          ls -la models/
          ls -la predictions/

      - name: Run update script
        id: update
        run: |
          python -m scripts.update > docs/index.md

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push website updates
        run: |
          git add docs/index.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Automated update - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Website Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

          if [ -f "docs/index.md" ]; then
            echo "- **Website**: Updated successfully" >> $GITHUB_STEP_SUMMARY
          fi
