name: Update Website

on:
  workflow_run:
    workflows: ["Fit Model"]
    types:
      - completed
  workflow_dispatch:

jobs:
  update-website:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: nfl
          environment-file: environment.yml
          python-version: 3.13

      - name: Verify environment
        shell: bash -el {0}
        run: |
          python -c "import pymc; print(f'PyMC version: {pymc.__version__}')"
          python -c "import nflreadpy; print('nflreadpy installed successfully')"

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: fit_model.yml
          name: model-*
          name_is_regexp: true
          path: temp-models/
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Move model
        run: |
          MODEL_FILE=$(find temp-models/ -name "model_*_*.nc" -type f | sort -V | tail -n 1)
          if [ -n "$MODEL_FILE" ]; then
            mkdir -p models/
            cp "$MODEL_FILE" models/
          else
            echo "Error: No model file found"
            exit 1
          fi
          rm -rf temp-models/

      - name: Run update script
        run: |
          python -m scripts.update --format "markdown" > docs/upcoming.md

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push website updates
        run: |
          git add docs/upcoming.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Automated website update - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
